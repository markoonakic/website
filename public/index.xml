<?xml version="1.0" encoding="utf-8"?><rss version="2.0" xml:lang="en-us" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>Marko Nakić</title>
        <link>http://localhost:1313</link>
        <description>Blog posts by Marko Nakić</description>
        <language>en-us</language>
        <lastBuildDate>Thu, 13 Nov 2025 22:35:18 &#43;0100</lastBuildDate>
        <pubDate>Mon, 10 Nov 2025 00:00:00 &#43;0000</pubDate>
        <ttl>60</ttl>
        <atom:link href="http://localhost:1313/index.xml" rel="self" type="application/rss+xml"/>
        <generator>Hugo 0.152.2</generator>
        <managingEditor>marko@markonakic.xyz (Marko Nakić)</managingEditor>
        <webMaster>marko@markonakic.xyz (Marko Nakić)</webMaster>
        <item>
            <title>Remote decryption using Dropbear SSH</title>
            <link>http://localhost:1313/posts/dropbear-shh/</link>
            <guid isPermaLink="true">http://localhost:1313/posts/dropbear-shh/</guid>
            <pubDate>Mon, 10 Nov 2025 00:00:00 &#43;0000</pubDate>
            <author>marko@markonakic.xyz (Marko Nakić)</author><description>My first encounter with encryption The first time i had encountered encryption was when i was installing Debian on a machine that was meant to be my first homelab. In the disk partitiong segment of …</description><content:encoded><![CDATA[<h2 id=my-first-encounter-with-encryption>My first encounter with encryption</h2><p>The first time i had encountered encryption was when i was installing Debian on a machine that was meant to be my first homelab. In the disk partitiong segment of the installation process I was presented with the option to use LUKS encryption on my drives. Since i had not yet dabbled with the idea, but found it cool, i decided to go with it and encrypt my drives.</p><p>Since i don&rsquo;t keep the homelab machine at my own place, I had to setup remote access to it right away. And in the process i realized - i cannot remotely decrypt my drives if the machine ever powers off. After that i scoured the web for solutions to my problem and in the end i landed on Dropbear SSH.</p><h2 id=what-is-dropbear-shh-and-how-does-it-apply-to-this-use-case>What is Dropbear SHH and how does it apply to this use case</h2><p>Dropbear SSH is a lightweigh SSH server and client that is primarily used on embedded systems with low memory and processor resources.</p><p>Most systems have some sort of pre-boot environment. This userspace is loaded into the RAM so that the kernel can load drivers and logic that&rsquo;s needed to mount the real root filesystem. The Linux kernel is shipped with the initramfs filesystem (or equivalent) by default.</p><p>Dropbear SHH can be leveraged to gain access to this pre-boot filesystem before the drives are mounted. This allows us to remotely decrypt the drives of our machine.</p><h2 id=implementation>Implementation</h2><p><strong>NOTE</strong> - This implementation walkthrough will be for Debian and Debian based systems, but the same principles still apply to others.</p><h3 id=update-and-upgrade-your-machine>Update and upgrade your machine</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sudo apt update
</span></span><span class=line><span class=cl>sudo apt upgrade
</span></span></code></pre></div><h3 id=install-dropbear>Install Dropbear</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sudo apt install dropbear-initramfs
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl> sudo -i
</span></span><span class=line><span class=cl> cd /etc/dropbear/initramfs/
</span></span></code></pre></div><p>Because these files affect the boot image, they live under /etc. Using <code>sudo -i</code> we can get a clean root environment that behaves as if we physically logged in as root.</p><h3 id=configure-dropbearconf>Configure dropbear.conf</h3><p>Options:</p><ul><li><code>-I</code> : Disconnect the session if no traffic is transmitted or received in x seconds</li></ul><p>Auto-disconnecting inactive sessions reduces exposure in the early boot process.</p><ul><li><p><code>-j</code>: Disable ssh local port forwarding.</p></li><li><p><code>-k</code> : Disable remote port forwarding.</p></li></ul><p>Disabling port forwarding minimizes attack surface.</p><ul><li><code>-p</code> : Dropbear listen on this specified TCP port.</li></ul><p>I always use a non default port to avoid generic scaning noise.</p><ul><li><code>-s</code> : Disable password logins.</li></ul><p>Always disable password logins and use key pairs for authentication.</p><p>Example:</p><pre><code>DROPBEAR_OPTIONS=&quot;-I 239 -j -k -p 5768 -s&quot;
</code></pre><h3 id=set-early-boot-networking>Set early-boot networking</h3><p>Early boot networking needs to be set in order for Dropbear to accept SSH before userspace networking is up. This is done by injecting a static IPv4 configuration in the initramfs config file => /etc/initramfs-tools/initramfs.conf.</p><p>Format:</p><pre><code>IP=SERVER_IP::ROUTER_IP:NETMASK:SERVER_HOSTNAME
</code></pre><p>Example:</p><pre><code>IP=192.168.1.36::192.168.1.1:255.255.255.0:node2
</code></pre><h3 id=update-the-initramfs>Update the initramfs</h3><pre><code>sudo update-initramfs -u -v
</code></pre><p>This rebuilds the initramfs with the changes for the current kernel. This command must be run after every change to the initramfs config so that it takes affect at boot.</p><h3 id=create-the-keys>Create the keys</h3><h4 id=generate-a-new-client-key>Generate a new client key</h4><pre><code>ssh-keygen -t rsa -f ~/.ssh/dropbear
</code></pre><p>The <code>-t</code> flag specifies what type of key to generate, while the <code>-f</code> flag specifies the file name and path.</p><h4 id=copy-the-key-to-the-server>Copy the key to the server:</h4><pre><code>scp ~/.ssh/dropbear.pub marko@192.168.0.200:~/dropbear.pub
</code></pre><p>Using scp we can copy the public key to the remote system of SSH.</p><h4 id=add-the-key-to-the-initramfs-authorized-keys>Add the key to the initramfs authorized keys:</h4><pre><code>cat /home/marko/dropbear.pub &gt;&gt; /etc/dropbear/initramfs/authorized_keys
</code></pre><p>The key needs to be present in the initramfs so the authentication can succeed during the pre-boot process.</p><h4 id=stop-being-root>Stop being root</h4><pre><code>exit
</code></pre><h4 id=update-initramfs-again>Update initramfs again</h4><pre><code>sudo update-initramfs -u
</code></pre><h3 id=making-an-alias-optional>Making an alias (optional)</h3><h4 id=edit-the-bashrc-on-the-client>Edit the bashrc on the client</h4><pre><code>vim ~/.bashrc
</code></pre><p>I suggest making an alias for ease of use.</p><h4 id=add-the-alias>Add the alias</h4><p>Format:</p><pre><code>alias &lt;Aliasname&gt;=&quot;ssh -i ~/.ssh/dropbear -p &lt;port&gt; -o 'HostKeyAlgorithms ssh-rsa' root@&lt;SERVER_IP&gt; 'echo -n &lt;DRIVE_ENCRYPTION_PASSWORD&gt; | cryptroot-unlock'&quot;
</code></pre><ul><li><code>-i</code> flag selects the private key we created</li><li><code>-p</code> flag specifies the dropbear port</li><li><code>-o</code> flag forces the use of the RSA algorithm with witch we crated the key pair</li><li><code>root@</code> ensures we connect as a root user to the server</li><li>The <code>echo</code> command is for ease of use and is optional, if not included you will have to provide the password manually to unlock</li></ul><p>Exemple:</p><pre><code>alias unlock=&quot;ssh -i ~/.ssh/dropbear -p 5768 -o 'HostKeyAlgorithms ssh-rsa' root@192.168.0.200 'echo -n test | cryptroot-unlock'&quot;
</code></pre><h4 id=source-the-bashrc>Source the bashrc:</h4><pre><code>source .bashrc
</code></pre><p>This reloads the shell configuration so the alias is available immediately.</p><h3 id=reboot>Reboot:</h3><pre><code>sudo reboot now
</code></pre><p>Time to reboot the machine and test it out!</p><h2 id=try-to-unlock-the-server-with-your-alias>Try to unlock the server with your alias:</h2><pre><code>unlock
</code></pre><h2 id=manual-unlock-with-no-alias>Manual unlock with no alias:</h2><pre><code>ssh -i ~/.ssh/dropbear -p &lt;port&gt; -o &quot;HostKeyAlgorithms ssh-rsa&quot; root@&lt;SERVER_IP&gt;
cryptroot-unlock
</code></pre>]]></content:encoded>
            <category>Linux</category>
            <category>Encryption</category>
            <category>Remote Access</category>
        </item>
    </channel>
</rss>
