{{ $page := . }}

{{ $class := slice }}
{{ $content := $page.Content }}
{{ $draft := $page.Draft }}
{{ $expired := and $page.ExpiryDate (lt $page.ExpiryDate now) }}
{{ $future := and $page.PublishDate (gt $page.PublishDate now) }}
{{ $microdata := $page.Params.microdata }}
{{ $min := $page.Param `params.full_width` | not }}
{{ $modified := and $page.PublishDate $page.Lastmod (lt $page.PublishDate $page.Lastmod) }}

{{ if $draft }}
    {{ $class = $class | append "status-draft" "status-unpublished" }}
{{ end }}

{{ if $expired }}
    {{ $class = $class | append "status-expired" "status-unpublished" }}
{{ end }}

{{ if $future }}
    {{ $class = $class | append "status-future" "status-unpublished" }}
{{ end }}

{{ if $modified }}
    {{ $class = $class | append "status-modified" }}
{{ end }}

{{ if not (or $draft $expired $future) }}
    {{ $class = $class | append "status-published" }}
{{ end }}

{{ with $page.Kind }}
    {{ if eq . "home" }}
        {{ $class = $class | append "kind-home" }}
    {{ else if eq . "section" }}
        {{ $class = $class | append "kind-section" }}
    {{ else if eq . "page" }}
        {{ $class = $class | append "kind-page" }}
    {{ else if eq . "taxonomy" }}
        {{ $class = $class | append "kind-taxonomy" }}
    {{ else if eq . "term" }}
        {{ $class = $class | append "kind-term" }}
    {{ end }}
{{ end }}

{{ $class = delimit ($class | uniq | sort) " " }}

{{ $isBlogLayout := eq $page.Layout "blog" }}
{{ $isTaxonomy := eq $page.Kind "taxonomy" }}
{{ $isTerm := eq $page.Kind "term" }}
{{ $hasContent := and $content (ne (trim $content "") "") }}
{{ $skipMain := or (and $isBlogLayout (not $hasContent)) (and $isTaxonomy (not $hasContent)) (and $isTerm (not $hasContent)) }}

<article class="{{ if $min }} align-items-center d-flex flex-column {{ end }} {{ $class }}" id="page">
    {{ partial "page-header.html" $page }}

    {{ if not $skipMain }}
        <main class="mw-100" id="page-content" {{ if $microdata }} itemprop="articleBody" {{ end }}>
            {{- $processedContent := $content -}}
            {{- if and (eq $page.Kind "home") $content -}}
                    {{- $original := resources.Get "images/beograd.png" -}}
                    {{- if not $original -}}
                        {{- $original = resources.Get "static/images/beograd.png" -}}
                    {{- end -}}
                {{- if $original -}}
                    {{- $widths := slice 800 1200 1600 -}}
                    {{- $webpImages := slice -}}
                    {{- $pngImages := slice -}}
                    {{- range $widths -}}
                        {{- $webp := $original.Resize (printf "%dx webp q95" .) -}}
                        {{- $png := $original.Resize (printf "%dx png q100" .) -}}
                        {{- $webpImages = $webpImages | append $webp -}}
                        {{- $pngImages = $pngImages | append $png -}}
                    {{- end -}}
                    {{- $webpSrcset := slice -}}
                    {{- range $idx, $img := $webpImages -}}
                        {{- $webpSrcset = $webpSrcset | append (printf "%s %dw" $img.RelPermalink (index $widths $idx)) -}}
                    {{- end -}}
                    {{- $pngSrcset := slice -}}
                    {{- range $idx, $img := $pngImages -}}
                        {{- $pngSrcset = $pngSrcset | append (printf "%s %dw" $img.RelPermalink (index $widths $idx)) -}}
                    {{- end -}}
                    {{- $defaultPng := index $pngImages 1 -}}
                    {{- $optimizedImage := printf `<picture>
    <source type="image/webp" srcset="%s" sizes="(max-width: 600px) 100vw, (max-width: 1200px) 125vw, 1500px">
    <img src="%s" srcset="%s" sizes="(max-width: 600px) 100vw, (max-width: 1200px) 125vw, 1500px" alt="Belgrade" class="belgrade-image" loading="lazy" width="%d" height="%d">
</picture>` (delimit $webpSrcset ", ") $defaultPng.RelPermalink (delimit $pngSrcset ", ") $defaultPng.Width $defaultPng.Height -}}
                    {{- $processedContent = $processedContent | replaceRE `<img src="/images/beograd.png" alt="Belgrade" class="belgrade-image">` $optimizedImage -}}
                {{- end -}}
            {{- end -}}
            {{ with $processedContent }}
                {{ . | safeHTML }}
            {{ end }}
        </main>
    {{ end }}

    {{ partial "page-footer.html" $page }}
</article>