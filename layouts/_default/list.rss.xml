{{- $page := . -}}
{{- $isHomePage := or $page.IsHome (eq $page.Kind "home") -}}
{{- if ne $page.Section "posts" -}}
    {{- if $isHomePage -}}
        {{- $page = site.GetPage "section" "posts" -}}
    {{- else -}}
        {{- return "" -}}
    {{- end -}}
{{- end -}}

{{- $dateFormat := "Mon, 02 Jan 2006 15:04:05 -0700" -}}
{{- $siteTitle := site.Title | markdownify | plainify | htmlUnescape -}}
{{- $siteDescription := site.Params.description | default (printf "Blog posts from %s" $siteTitle) | markdownify | plainify | htmlUnescape -}}
{{- $language := site.LanguageCode | default "en-us" -}}
{{- $limit := default 20 site.Config.Services.RSS.Limit -}}
{{- $siteURL := strings.TrimSuffix "/" site.BaseURL -}}
{{- $rssURL := cond $isHomePage (printf "%s/index.xml" $siteURL) (printf "%s/posts/index.xml" $siteURL) -}}

{{- $posts := where site.RegularPages "Section" "posts" -}}
{{- $posts = where $posts "Draft" false -}}
{{- $posts = sort $posts "Date" "desc" -}}
{{- if gt $limit 0 -}}
    {{- $posts = $posts | first $limit -}}
{{- end -}}

{{- $lastmod := now.Format $dateFormat -}}
{{- $pubDate := cond (gt (len $posts) 0) ((index $posts 0).PublishDate.Format $dateFormat) $lastmod -}}
{{- $authorName := site.Params.author.name | default $siteTitle -}}
{{- $authorEmail := site.Params.author.email | default "" -}}

{{- safeHTML "<?xml version=\"1.0\" encoding=\"utf-8\"?>" -}}
<rss version="2.0" xml:lang="{{ $language }}" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>{{ $siteTitle }}</title>
        <link>{{ $siteURL }}</link>
        <description>{{ $siteDescription }}</description>
        <language>{{ $language }}</language>
        <lastBuildDate>{{ $lastmod }}</lastBuildDate>
        <pubDate>{{ $pubDate }}</pubDate>
        <ttl>60</ttl>
        <atom:link href="{{ $rssURL }}" rel="self" type="application/rss+xml"/>
        <generator>Hugo {{ hugo.Version }}</generator>
        {{- if site.Copyright }}
        <copyright>{{ site.Copyright | markdownify | plainify | htmlUnescape }}</copyright>
        {{- end }}
        {{- if $authorEmail }}
        <managingEditor>{{ $authorEmail }} ({{ $authorName }})</managingEditor>
        <webMaster>{{ $authorEmail }} ({{ $authorName }})</webMaster>
        {{- end }}
        {{- range $post := $posts }}
        <item>
            <title>{{ $post.Title | markdownify | plainify | htmlUnescape | transform.XMLEscape }}</title>
            <link>{{ $post.Permalink }}</link>
            <guid isPermaLink="true">{{ $post.Permalink }}</guid>
            <pubDate>{{ $post.PublishDate.Format $dateFormat }}</pubDate>
            {{- $postAuthor := "" -}}
            {{- $authors := partial "func-authors.html" $post -}}
            {{- if $authors }}
                {{- $primary := index $authors 0 -}}
                {{- if and $primary.Params.author.email $primary.Params.author.name }}
                    {{- $postAuthor = printf "%s (%s)" $primary.Params.author.email ($primary.Params.author.name | default ($primary.Title | markdownify | plainify)) -}}
                {{- else if $primary.Params.author.email }}
                    {{- $postAuthor = $primary.Params.author.email -}}
                {{- else if $primary.Params.author.name }}
                    {{- $postAuthor = printf "noreply@%s (%s)" (urls.Parse $siteURL).Host ($primary.Params.author.name | default ($primary.Title | markdownify | plainify)) -}}
                {{- end }}
            {{- end }}
            {{- if not $postAuthor }}
                {{- if $authorEmail }}
                    {{- $postAuthor = printf "%s (%s)" $authorEmail $authorName -}}
                {{- end }}
            {{- end }}
            {{- if $postAuthor }}
            <author>{{ $postAuthor }}</author>
            {{- end }}
            {{- $description := $post.Description | default ($post.Summary | plainify | truncate 200) | markdownify | plainify | htmlUnescape -}}
            <description>{{ $description | transform.XMLEscape }}</description>
            {{- $content := $post.Content -}}
            {{- if $content }}
                {{- $content = replaceRE `<a href="#fn:(\d+)" class="footnote-ref" role="doc-noteref">` (printf `<a href="%s#fn:$1" class="footnote-ref" role="doc-noteref">` $post.Permalink) $content -}}
                {{- $content = replaceRE `<a href="#fnref:(\d+)" class="footnote-backref" role="doc-backlink">` (printf `<a href="%s#fnref:$1" class="footnote-backref" role="doc-backlink">` $post.Permalink) $content -}}
                {{- $content = replaceRE `(src|href)="(/(?:[^"]+)?)"` (printf `$1="%s$2"` $siteURL) $content -}}
                {{- $content = partial "func-minify.html" (dict "content" $content) -}}
            <content:encoded>{{ printf "<![CDATA[%s]]>" $content | safeHTML }}</content:encoded>
            {{- end }}
            {{- if $post.Params.tags }}
                {{- range $tag := $post.Params.tags }}
            <category>{{ $tag | transform.XMLEscape }}</category>
                {{- end }}
            {{- end }}
        </item>
        {{- end }}
    </channel>
</rss>
